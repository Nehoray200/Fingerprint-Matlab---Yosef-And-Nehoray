%% ×“×•×§×˜×•×¨ ×œ××¢×¨×›×ª - ×‘×“×™×§×ª ×©×¤×™×•×ª
clc; clear; close all;

% ×”×•×¡×¤×ª × ×ª×™×‘×™×
addpath(genpath('src'));

disp('=== ××ª×—×™×œ ×‘×“×™×§×ª ××‘×—×•×Ÿ ===');

% 1. ×˜×¢×™× ×ª ×ª××•× ×”
[f, p] = uigetfile('*.*', '×‘×—×¨ ×ª××•× ×” (×¨×¦×•×™ ×§×•×‘×¥ TIF ××§×•×¨×™)');
if isequal(f,0), return; end
img = imread(fullfile(p, f));

% 2. ×‘×“×™×§×ª ×©×œ×‘ ×”×¢×™×‘×•×“ (Process)
disp('>> ××¨×™×¥ process_fingerprint...');
try
    [template, roi, raw] = process_fingerprint(img);
catch ME
    error(['×”×¤×•× ×§×¦×™×” ×§×¨×¡×”! ×”×•×“×¢×ª ×©×’×™××”: ' ME.message]);
end

numPoints = size(template, 1);
disp(['   ××¡×¤×¨ × ×§×•×“×•×ª ×©× ××¦××•: ' num2str(numPoints)]);

% --- ×‘×“×™×§×” ×§×¨×™×˜×™×ª 1: ×”×× × ××¦××• × ×§×•×“×•×ª? ---
if numPoints < 5
    disp('ğŸ›‘ ×ª×§×œ×” ×§×¨×™×˜×™×ª: × ××¦××• ×¤×—×•×ª ×-5 × ×§×•×“×•×ª!');
    disp('   ×¡×™×‘×” ××¤×©×¨×™×ª: ×”×ª××•× ×” "×”×¤×•×›×”" (×¨×§×¢ ×œ×‘×Ÿ ×•×¨×›×¡×™× ×©×—×•×¨×™×).');
    disp('   ×¤×ª×¨×•×Ÿ: ×‘-extract_minutiae_features, ×ª×•×•×“× ×©×™×© ×”×™×¤×•×š ×¦×‘×¢×™×.');
    
    % ×”×¦×’×ª ×”×©×œ×“ ×œ×‘×“×™×§×” ×‘×¢×™×Ÿ
    figure; imshow(get_roi_mask(img)); title('×”×× ×–×” × ×¨××” ×›××• ×˜×‘×™×¢×ª ××¦×‘×¢?');
    return;
end

% --- ×‘×“×™×§×” ×§×¨×™×˜×™×ª 2: ×‘×“×™×§×ª ×–×•×•×™×•×ª (××¢×œ×•×ª ××• ×¨×“×™×× ×™×?) ---
angles = template(:, 4);
maxAngle = max(abs(angles));
disp(['   ×”×–×•×•×™×ª ×”×›×™ ×’×“×•×œ×” ×©× ××¦××” (×‘×¢×¨×š ××•×—×œ×˜): ' num2str(maxAngle)]);

if maxAngle > 7 % 2*pi ×–×” ×‘×¢×¨×š 6.28
    disp('ğŸ›‘ ×ª×§×œ×” ×§×¨×™×˜×™×ª: ×”×–×•×•×™×•×ª ×‘××¢×œ×•×ª! (×¢×¨×š ×’×“×•×œ ×-6.28)');
    disp('   ×”××¢×¨×›×ª ×¢×•×‘×“×ª ×¨×§ ×¢× ×¨×“×™×× ×™×.');
    disp('   ×¤×ª×¨×•×Ÿ: ×‘-extract_minutiae_features, ×ª××—×§ ×›×œ ×”×›×¤×œ×” ×‘- (180/pi).');
    return;
else
    disp('âœ… ×–×•×•×™×•×ª ×ª×§×™× ×•×ª (×¨×“×™×× ×™×).');
end

% 3. ×‘×“×™×§×ª ×”×ª×××” ×¢×¦××™×ª (Self Match)
disp('---------------------------------');
disp('>> ××¨×™×¥ ×‘×“×™×§×ª ×”×ª×××” (×ª××•× ×” ××•×œ ×¢×¦××”)...');

% ×©×™××•×© ×‘×¤×•× ×§×¦×™×” find_best_match
[score, aligned, isMatch] = find_best_match(template, template, 0);

disp(['   ×¦×™×•×Ÿ ×©×”×ª×§×‘×œ: ' num2str(score)]);

if score > 90
    disp('âœ… ×”××¢×¨×›×ª ×ª×§×™× ×”! (×¦×™×•×Ÿ ×’×‘×•×” ×‘×‘×“×™×§×” ×¢×¦××™×ª)');
    disp('   ×× ×–×” ×œ× ×¢×‘×“ ×§×•×“×, ××•×œ×™ ×”-Config ×œ× × ×˜×¢×Ÿ × ×›×•×Ÿ ×‘-Main.');
else
    disp('ğŸ›‘ ×”×ª×××” ×¢×¦××™×ª × ×›×©×œ×” (×”×¦×™×•×Ÿ ×××•×¨ ×œ×”×™×•×ª 100).');
    disp('   ×¡×™×‘×” ××¤×©×¨×™×ª: ×”×¤×•× ×§×¦×™×” find_best_match ××¡× × ×ª × ×§×•×“×•×ª ×‘×’×œ×œ "Type".');
    disp('   ×¤×ª×¨×•×Ÿ: ×›× ×¡ ×œ-find_best_match ×•×”×¤×•×š ×œ×”×¢×¨×” ××ª ×”×©×•×¨×”: if T_types(i) ~= D_types(j)...');
end